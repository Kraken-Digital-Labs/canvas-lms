

```
sudo -u postgres createuser $USER
sudo -u postgres psql -c "alter user $USER with superuser" postgres
```



#Instalador de Canvas

#Instalaci贸n de PostgresSQL
sudo apt-get install postgresql-12

sudo -u postgres createuser canvas --no-createdb --no-superuser --no-createrole --pwprompt

sudo -u postgres createdb canvas_production --owner=canvas

sudo -u postgres createdb canvas_development --owner=canvas

sudo -u postgres createuser $USER

sudo -u postgres psql -c "alter user $USER with superuser" postgres

#Instalaci贸n de Git

sudo apt-get install curl git git-core

sudo apt-get install software-properties-common

#Instalaci贸n de Ruby

sudo add-apt-repository ppa:instructure/ruby

sudo apt-get update

sudo apt-get install ruby3.1 ruby3.1-dev zlib1g-dev libxml2-dev libsqlite3-dev postgresql libpq-dev libxmlsec1-dev libidn11-dev curl make g++

#Instalaci贸n de Yarn

curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash; source ~/.bashrc; nvm install 18.1.0

curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.19.1

sudo git clone https://github.com/instructure/canvas-lms.git canvas

current_user=$(whoami)


new_directory="/var"

cd "$new_directory"

sudo chown -R "$current_user":"$current_user" "$new_directory"/canvas

cd canvas

git checkout prod

for config in amazon_s3 database delayed_jobs domain file_store outgoing_mail security external_migration

do cp config/$config.yml.example config/$config.yml

cp config/database.yml.example config/database.yml; nano config/database.yml;

cp config/dynamic_settings.yml.example config/dynamic_settings.yml; nano config/dynamic_settings.yml

cp config/outgoing_mail.yml.example config/outgoing_mail.yml; nano config/outgoing_mail.yml
______________________________________________
#outgoing_mail.yml => 

enable_starttls_auto: false
ssl: true

production:
address: smtp.gmail.com # Your SMTP server address
port: "465" # Port 465 for SSL
enable_starttls_auto: false # Disable TLS
ssl: true # Enable SSL
user_name: "{Your_SMTP_OR_GMAIL_USERNAME}"
password: "{Your_SMTP_OR_GMAIL_PASSWORD}"
authentication: cram_md5 # secure authentication
domain: smtp.gmail.com # Your SMTP server address
outgoing_address: "{YOUR_EMAIL}"
default_name: "{YOUR_FROM_NAME_ON_EMAILS}"
______________________________________________

cp config/domain.yml.example config/domain.yml; nano config/domain.yml;

cp config/security.yml.example config/security.yml; nano config/security.yml; 

security.yml => 

______________________________________________
production: &default

encryption_key: daedd3a131ddd8988b14f6e4e01039c93cfa0160

lti_iss: 'dominio.com'
______________________________________________

sudo apt-get install libyaml-dev

sudo gem install bundler --version 2.3.26

bundle config set --local path vendor/bundle

bundle install

sudo gem update strscan

sudo gem uninstall stringio

sudo gem install stringio -v 3.0.8

yarn install

mv db/migrate/20210823222355_change_immersive_reader_allowed_on_to_on.rb .

mv db/migrate/20210812210129_add_singleton_column.rb db/migrate/20111111214311_add_singleton_column.rb

yarn gulp rev

RAILS_ENV=production bundle exec rake db:initial_setup

mv 20210823222355_change_immersive_reader_allowed_on_to_on.rb db/migrate/.

RAILS_ENV=production bundle exec rake db:migrate

mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands

touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss Gemfile.lock log/production.log

RAILS_ENV=production bundle exec rake canvas:compile_assets

sudo apt-get install apache2

sudo apt-get install -y dirmngr gnupg apt-transport-https ca-certificates

sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7

sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger focal main > /etc/apt/sources.list.d/passenger.list'

sudo apt-get update

sudo apt-get install -y libapache2-mod-passenger

sudo a2enmod rewrite

sudo a2enmod passenger

sudo a2enmod ssl

sudo nano /etc/apache2/mods-available/passenger.conf

passenger.conf  => 


______________________________________________
PassengerDefaultUser USUARIO
PassengerStartTimeout 180
PassengerPreloadBundler On
#PassengerFriendlyErrorPages On
______________________________________________

 #SSL

 
sudo apt update; sudo apt install certbot;

sudo apt install python3-certbot-apache

Cert: /etc/letsencrypt/live/dominio.com/fullchain.pem 

Key: /etc/letsencrypt/live/dominio.com/privkey.pem

# For Apache
sudo certbot --apache -d dominio.com

crontab -e 

0 0 * * * /usr/bin/certbot renew --quiet 


sudo nano /etc/apache2/sites-available/canvas.conf

canvas.conf  => 
Caso 1
-------------------------------------
<VirtualHost *:80>
  ServerName dominio.com
  ServerAlias canvasfiles.example.com
  ServerAdmin youremail@example.com
  DocumentRoot /var/canvas/public
  PassengerRuby /usr/bin/ruby3.1
  PassengerAppEnv production
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_ssl_access.log combined
  RewriteEngine On
  RewriteCond %{HTTP:X-Forwarded-Proto} !=https
  RewriteCond %{REQUEST_URI} !^/health_check
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L]
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_access.log combined
  SetEnv RAILS_ENV production
  RailsEnv production
  XSendFile On
  XSendFilePath /var/canvas
<Directory /var/canvas/public>
AllowOverride all
Options -MultiViews
Require all granted
</Directory>
</VirtualHost>
# If you are only serving HTTP behind a HTTPS-terminating load balancer, skip the next VirtualHost
<VirtualHost *:443>
  ServerName dominio.com
  ServerAlias canvasfiles.example.com
  ServerAdmin youremail@example.com
  DocumentRoot /var/canvas/public
  PassengerRuby /usr/bin/ruby3.1
  PassengerAppEnv production
  SetEnv RAILS_ENV production
  RailsEnv production
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_ssl_access.log combined
  SSLEngine on
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
  # the following ssl certificate files are generated for you from the ssl-cert package.
  SSLCertificateFile /etc/letsencrypt/live/dominio.com/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/dominio.com/privkey.pem
  Include /etc/letsencrypt/options-ssl-apache.conf
  XSendFile On
  XSendFilePath /var/canvas
  ProxyPass /api/session http://localhost:3001/api/session
  ProxyPassReverse /api/session http://localhost:3001/api/session
  <Directory /var/canvas/public>
    Options All
    AllowOverride All
    Require all granted
  </Directory>
</VirtualHost>

-------------------------------------

Caso 2
___________________________________
VirtualHost *:80>
  ServerName lms.paisdelconocimiento.org
  ServerAlias lmsx.eastus.cloudapp.azure.com
  ServerAdmin juan.villa@paisdelconocimiento.org
  DocumentRoot /var/canvas/public
  RewriteEngine On
  RewriteCond %{HTTP:X-Forwarded-Proto} !=https
  RewriteCond %{REQUEST_URI} !^/health_check
  RewriteRule (.*) <https://%{HTTP_HOST}%{REQUEST_URI>} [L]
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_access.log combined
  SetEnv RAILS_ENV production
  <Directory /var/canvas/public>
    Allow from all
    Options -MultiViews
  </Directory>
</VirtualHost>
<VirtualHost *:443>
  ServerName lms.paisdelconocimiento.org
  ServerAlias lmsx.eastus.cloudapp.azure.com
  ServerAdmin juan.villa@paisdelconocimiento.org
  DocumentRoot /var/canvas/public
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_ssl_access.log combined
  SSLEngine on
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
  # the following ssl certificate files are generated for you from the ssl-cert package.
  SSLCertificateFile /etc/letsencrypt/live/lms.paisdelconocimiento.org/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/lms.paisdelconocimiento.org/privkey.pem
  Include /etc/letsencrypt/options-ssl-apache.conf
  SetEnv RAILS_ENV production
  <Directory /var/canvas/public>
    Options All
    AllowOverride All
    Require all granted
  </Directory>
</VirtualHost>
______________________________________________

sudo apt-get install libapache2-mod-xsendfile

sudo apachectl -M | sort

sudo a2ensite canvas.conf

sudo a2enmod proxy_http

sudo service apache2 restart

sudo add-apt-repository ppa:chris-lea/redis-server

sudo apt-get update

sudo apt-get install redis-server

sudo systemctl start redis-server

sudo systemctl enable redis-server

sudo cp config/cache_store.yml.example config/cache_store.yml

sudo nano config/cache_store.yml; 

cache_store.yml
______________________________________________
test:
cache_store: redis_cache_store
development:
cache_store: redis_cache_store
production:
cache_store: redis_cache_store 
______________________________________________

sudo chown USER config/cache_store.yml
sudo chmod 400 config/cache_store.yml

sudo cp config/redis.yml.example config/redis.yml

cd /var/canvas/

sudo cp config/redis.yml.example config/redis.yml

sudo nano config/redis.yml;

redis.yml
______________________________________________
production:
url:
- redis://localhost
______________________________________________

sudo chown USER config/redis.yml

sudo chmod 400 config/redis.yml

sudo ln -s /var/canvas/script/canvas_init /etc/init.d/canvas_init

sudo update-rc.d canvas_init defaults

sudo /etc/init.d/canvas_init start

sudo ufw allow 80

sudo ufw allow 80/tcp

sudo ufw allow 443

sudo ufw allow 443/tcp

sudo ufw allow 3001

sudo ufw allow 3001/tcp

sudo ufw allow ssh

sudo ufw enable

sudo ufw reload

git clone https://github.com/instructure/canvas-rce-api.git

cd canvas-rce-api

npm install --production

npm audit fix; cp .env.example .env

ECOSYSTEM_SECRET=$(unique_string=$(head -c 32 /dev/urandom | base64 | tr -d '+/=' | tr -dc 'a-zA-Z0-9' | head -c 32)

echo $unique_string)

echo $ECOSYSTEM_SECRET

ECOSYSTEM_KEY=$(unique_string=$(head -c 32 /dev/urandom | base64 | tr -d '+/=' | tr -dc 'a-zA-Z0-9' | head -c 32)

echo $unique_string)

echo $ECOSYSTEM_KEY

CIPHER_PASSWORD=$(openssl rand -hex 16)

sed -i "s/^\(NODE_ENV=\).*/\1production/

s/^\(ECOSYSTEM_SECRET=\).*/\1$ECOSYSTEM_SECRET/

s/^\(ECOSYSTEM_KEY=\).*/\1$ECOSYSTEM_KEY/

s/^\(CIPHER_PASSWORD=\).*/\1$CIPHER_PASSWORD/" .env

nano .env 

cd ..

cp config/vault_contents.yml.example config/vault_contents.yml

nano config/vault_contents.yml;

vault_contents.yml
______________________________________________
#Replace development with production
production:
'sts/testaccount/sts/canvas-shards-lookupper-dev':
access_key: 'fake-access-key'
secret_key: 'fake-secret-key'
security_token: 'fake-security-token'
'sts/testaccount/sts/canvas-release-notes':
access_key: 'fake-access-key'
secret_key: 'fake-secret-key'
security_token: 'fake-security-token'
'app-canvas/data/secrets':
data:
canvas_security:
encryption_secret: "YOUR_ECOSYSTEM_KEY"
signing_secret: "YOUR_ECOSYSTEM_SECRET"
#ECOSYSTEM_KEY & ECOSYSTEM_SECRET copied from the .env file. 

nano config/dynamic_settings.yml;

dynamic_settings.yml
______________________________________________
rich-content-service:
# if you're running canvas-rce-api on its own
app-host: "dominio.com"
# if you're running canvas-rce-api with docker-compose/rce-api.override.yml in .env
# app-host: "http://rce.canvas.docker:3000"
______________________________________________


cd canvas-rce-api; sudo apt install screen; screen -S canvas-rce-api

npm run start

press Ctrl + a and d  to detach from the screen

cd /var/canvas

current_user=$(whoami)

sudo chown -R "$current_user":"$current_user" .

sudo find config/ -type f -exec chmod 400 {} +

nano config/environments/production-local.rb;

production-local.rb:
______________________________________________
# If you have mod_xsendfile enabled in Apache:
config.action_dispatch.x_sendfile_header = 'X-Sendfile'
______________________________________________

sudo ln -s /var/canvas/script/canvas_init /etc/init.d/canvas_init

sudo update-rc.d canvas_init defaults

sudo /etc/init.d/canvas_init start

sudo /etc/init.d/apache2 restart

sudo /etc/init.d/canvas_init restart

psql canvas_production -c "select last_error from delayed_jobs order by updated_at desc limit 1;"

sudo /etc/init.d/canvas_init status

psql canvas_production -c "select message, backtrace from error_reports order by id desc limit 1;"

cd /var/canvas

sudo su canvasuser -c "env GEM_HOME=/home/USER/gems \
                                      RAILS_ENV=production script/console"

cd ~/canvas

GEM_HOME=~/gems script/console

# tweak footer
CONF=$WEBROOT/app/views/layouts/application.html.erb
sed -i "s|</footer>|<div id='turnkey-credit' style='text-align:center;padding-top:20px;'><a href='https://www.turnkeylinux.org/canvas'>Canvas Appliance</a> - Powered by <a href='https://www.turnkeylinux.org'>TurnKey Linux</a></div>\n    </footer>|" $CONF

isable SELinux - REQUIRED

Currently Kaltura doesn't properly support running with SELinux, things will break if you don't set it to permissive. If your instance has it enabled [by default Debian and Ubuntu do not enable SELinux], run:

# setenforce permissive

To verify SELinux will not revert to enabled next restart:

    Edit the file /etc/selinux/config
    Verify or change the value of SELINUX to permissive: SELINUX=permissive
    Save the file /etc/selinux/config
